var application={KEYS:{A:65},now:new Date,today:null,isSearching:false,isLoading:false,autoFocus:false,trottleSearch:null,controlPressed:false,majPressed:false,multiSelectLastEntry:null,init:function(){moment.locale(this.getCurrentLocale());this.i18n();this.today=new Date(this.now.getFullYear(),this.now.getMonth(),this.now.getDate(),0,0,0,0);if($("body.popup").length){this.initPopup()}else{this.initMain()}},initPopup:function(){this.historyGetDay(this.today,10);$("#go_history").on("click",function(e){e.preventDefault();chrome.tabs.create({url:"chrome://history"})})},initMain:function(){let $this=this;this.trottleSearch=_.debounce(this.historySearch,500);$("#search_input").focusin(function(){$(this).parent().addClass("focus")}).focusout(function(){$(this).parent().removeClass("focus")}).on("keyup",function(){$this.inputSearch()});$("#search_clear").on("click",function(e){e.preventDefault();$this.clearSearch()});this.initCalendar();$("#go_today").on("click",function(e){e.preventDefault();$this.historyGetDay($this.today);$this.initCalendar()});$(".remove-confirmation>#clear_confirm").on("click",function(e){e.preventDefault();$this.removeSelectedEntires()});$(".remove-confirmation>#clear_cancel").on("click",function(e){e.preventDefault();$this.clearSelectedItems()});$(document).keydown(function(e){if(e.which==17){$this.controlPressed=true}else if(e.which==16){$this.majPressed=true}else{$this.keypressMulti(e)}}).keyup(function(e){if(e.which==17){$this.controlPressed=false}else if(e.which==16){$this.majPressed=false}}).click(function(e){if(!$this.is(e.target,"entry")&&!$this.is(e.target,"remove-confirmation")){$this.clearSelectedItems()}});this.historyGetDay(this.today)},initCalendar:function(){let $this=this;if($(".sidebar .calendar .ic__container").length){$(".sidebar .calendar").remove()}let calendar=$("<div />").addClass("calendar");$(".sidebar .nav .content").prepend(calendar);calendar.ionCalendar({lang:this.getCurrentLocale(),sundayFirst:moment.localeData().firstDayOfWeek()==0,startDate:this.today,years:this.now.getFullYear()-3+"-"+this.now.getFullYear(),onClick:function(date){$this.historyGetDay(new Date(date))}})},inputSearch:function(){let search_query=$("#search_input").val();if(search_query.toString()!==""){$("#search_clear").css("display","flex");this.trottleSearch(search_query)}else{if(this.isSearching){this.clearContent();this.historyGetDay(this.today)}this.trottleSearch.cancel();this.isSearching=false;$("#search_clear").hide()}},clearSearch:function(){$("#search_input").val("");this.inputSearch()},historySearch:function(query){this.isSearching=true;this.clearContent();this.historyQuery(query,new Date(1970,1,1,0,0,0,0),new Date(this.today.getFullYear(),this.today.getMonth(),this.today.getDate(),23,59,59),0)},historyGetDay:function(day,nb_entries){nb_entries=nb_entries||0;if(day>this.now){return}let date_start=new Date(day.getFullYear(),day.getMonth(),day.getDate(),0,0,0,0);let date_end=new Date(day.getFullYear(),day.getMonth(),day.getDate(),23,59,59);this.clearContent();this.historyQuery("",date_start,date_end,nb_entries)},historyQuery:function(search,start,end,nb_entries){let $this=this;this.isLoading=true;chrome.history.search({text:search,startTime:start.getTime(),endTime:end.getTime(),maxResults:nb_entries},function(results){$this.historyCallback(results,start,end)})},historyCallback:function(results,start,end){let items={};let count=0;$.each(results,function(k,v){let item_date=new Date(v.lastVisitTime);if(item_date>=start&&item_date<=end){let item_key=new Date(item_date.getFullYear(),item_date.getMonth(),item_date.getDate(),0,0,0,0).getTime().toString();if(!items[item_key]){items[item_key]=[]}items[item_key].push(v);count++}});if($.isEmptyObject(items)){items[start.getTime()]={}}this.historyFormatDays(items,count)},historyFormatDays:function(items,count){let $this=this;this.clearContent();if(this.isSearching){this.insertContent("<h1>"+chrome.i18n.getMessage("search_display")+' "'+$("#search_input").val()+'"</h1>');if(count>0){this.insertContent('<div class="search-result">'+chrome.i18n.getMessage("search_found",count.toString())+"</div>")}else{this.insertContent('<div class="search-result">'+chrome.i18n.getMessage("search_empty")+"</div>");this.isLoading=false;return}}$.each(items,function(k,day){let html="";k=k.toString();if($(".wrapper .history-container #"+k).length<1){html+='<div class="history-day" id="'+k+'">'}html+="<h2>"+moment(new Date(parseFloat(k.toString()))).format(chrome.i18n.getMessage("date_format"))+"</h2>";if(Object.keys(day).length>0){$.each(day,function(z,entry){html+=$this.historyEntryFormat(entry)})}else{html+='<div class="entry-empty">'+chrome.i18n.getMessage("history_date_empty")+"</div>"}if($(".wrapper .history-container #"+k).length<1){html+="</div>"}$this.insertContent(html)});this.historyEntriesBind();this.isLoading=false},historyEntryFormat:function(entry){let html="";html+='<div class="entry">';html+='<img class="entry-icon" src="'+this.getFavicon(entry.url,2)+'" />';html+='<div class="entry-link"><a href="'+this.escape(entry.url)+'" target="_blank" title="'+this.escape(entry.url)+'">'+this.escape(entry.title?entry.title:entry.url)+"</a></div>";html+='<div class="entry-time">'+moment(new Date(entry.lastVisitTime)).format("LT")+"</div>";html+='<a class="entry-remove" title="'+chrome.i18n.getMessage("history_remove_single")+'"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 15" width="12px" height="12px" slot="before"><path d="M14.1016 1.60156L8.20312 7.5L14.1016 13.3984L13.3984 14.1016L7.5 8.20312L1.60156 14.1016L0.898438 13.3984L6.79688 7.5L0.898438 1.60156L1.60156 0.898438L7.5 6.79688L13.3984 0.898438L14.1016 1.60156Z"></path></svg></a>';html+="</div>";return html},historyEntryDelete:function(url,sender){let $this=this;chrome.history.deleteUrl({url:url},function(){let container=sender.parent().parent();sender.parent().remove();if($(".entry",container).length===0){$this.insertContent('<div class="entry-empty">'+chrome.i18n.getMessage("history_date_empty")+"</div>",container)}$this.updateConfirm()})},historyEntriesBind:function(){let $this=this;$(".history-container .entry>.entry-remove").unbind();$(".history-container .entry>.entry-remove").on("click",function(e){e.preventDefault();$this.historyEntryDelete($(this).parent().find(".entry-link>a").attr("href"),$(this))});$(".history-container .entry",$("body.main")).unbind();$(".history-container .entry",$("body.main")).on("click",function(e){if(!$(e.target).is("a")&&!$this.is(e.target,"entry-remove")){e.preventDefault();if($this.majPressed&&$this.multiSelectLastEntry!==null){let tmp=$this.multiSelectLastEntry;document.getSelection().removeAllRanges();if($(this).offset().top>$this.multiSelectLastEntry.offset().top){while($(this).offset().top>tmp.offset().top){tmp=tmp.next();tmp.addClass("selected")}}else{while(tmp.offset().top>$(this).offset().top){tmp=tmp.prev();tmp.addClass("selected")}}}else{$this.multiSelectLastEntry=$(this);if($(this).hasClass("selected")){$(this).removeClass("selected")}else{$(this).addClass("selected")}}$this.updateConfirm()}})},keypressMulti:function(e){if($(e.target).attr("id")!=="search_input"){if(this.controlPressed&&e.which==this.KEYS.A){e.preventDefault();$(".history-container .entry").addClass("selected");this.updateConfirm()}}if(e.which==46){if($(".history-container .entry.selected").length>0){this.removeSelectedEntires()}}},updateConfirm:function(){let count=$(".history-container .entry.selected").length;if(count>0){$(".remove-confirmation").show();$(".remove-confirmation>.num").html(count.toString())}else{$(".remove-confirmation").hide()}},clearSelectedItems:function(){$(".history-container .entry.selected").removeClass("selected");this.multiSelectLastEntry=null;this.updateConfirm()},removeSelectedEntires:function(){$(".history-container .entry.selected").each(function(){$(this).find(".entry-remove").click()})},insertContent:function(html,context){context=context||null;if(context!==null){context.append(html)}else{$(".wrapper .history-container .content").append(html)}},clearContent:function(){$(".wrapper .history-container .content").html("")},i18n:function(){$("[i18n]").each(function(){let i18n=$(this).attr("i18n");if(i18n.indexOf(":")>=0){let tmp=i18n.split(":");$(this).attr(tmp[0],chrome.i18n.getMessage(tmp[1]))}else{$(this).html(chrome.i18n.getMessage(i18n))}})},is:function(target,classname){return!!($(target).hasClass(classname)||$(target).parents("."+classname).length>0)},getCurrentLanguage:function(){return this.getCurrentLocale().substr(0,2)},getCurrentLocale:function(){return chrome.i18n.getMessage("language")},getFavicon:function(url,size){size=size||1;return"chrome://favicon/size/16@"+size+"x/"+this.escape(url)},escape:function(string){return string.replace(/&/g,"&amp;").replace(/</g,"&#x3C;").replace(/>/g,"&#x3E;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}};$(function(){application.init()});